<div class="calendar-container">
  <!-- Barre d'outils pour la sélection multiple -->
  <div
    class="selection-toolbar"
    *ngIf="isMultiSelectMode && config.showMultiSelection"
  >
    <div class="toolbar-info">
      <span class="selection-count"
        >{{ selectedCells.size }} cellule(s) sélectionnée(s)</span
      >
    </div>
    <div class="toolbar-actions">
      <button class="btn btn-primary" (click)="manageSelection()">
        <i class="icon-manage"></i> Gérer la sélection
      </button>
      <button class="btn btn-secondary" (click)="clearSelection()">
        <i class="icon-clear">Effacer la sélection</i>
      </button>
    </div>
  </div>

  <!-- Tableau calendrier -->
  <div class="calendar-table-wrapper">
    <!-- En-tête avec les dates/mois -->
    <div class="calendar-header-sticky">
      <div
        class="employee-column-header"
        [style.width.px]="employeeColumnWidth"
      >
        <span>Employés</span>

        <!-- Champ de recherche d'employés (conditionnel) -->
        <div class="employee-search" *ngIf="config.showEmployeeSearch">
          <div class="search-input-container">
            <input
              type="text"
              [(ngModel)]="employeeSearchTerm"
              (input)="onEmployeeSearch()"
              placeholder="Rechercher un employé..."
              class="employee-search-input"
            />
            <button
              *ngIf="employeeSearchTerm"
              (click)="clearEmployeeSearchHandler()"
              class="clear-search-btn"
              title="Effacer la recherche"
            >
              ✕
            </button>
          </div>

          <!-- Liste d'autocomplétion -->
          <div class="autocomplete-list" *ngIf="filteredEmployees.length > 0">
            <div
              *ngFor="let employee of filteredEmployees"
              class="autocomplete-item"
              (click)="selectEmployee(employee)"
            >
              <div class="employee-info">
                <span class="employee-name"
                  >{{ employee.firstName }} {{ employee.lastName }}</span
                >
                <span class="employee-dept"
                  >{{ employee.department }} - {{ employee.position }}</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="dates-header-container" #datesHeaderContainer>
        <!-- Contrôles de navigation pour vue année -->
        <div class="scroll-controls-left" *ngIf="config.viewMode === 'year'">
          <button
            class="scroll-btn scroll-left"
            (click)="scrollToPreviousMonth()"
            [disabled]="!canScrollLeft"
          >
            ← {{ previousMonthName }}
          </button>
        </div>

        <div class="scroll-controls-right" *ngIf="config.viewMode === 'year'">
          <button
            class="scroll-btn scroll-right"
            (click)="scrollToNextMonth()"
            [disabled]="!canScrollRight"
          >
            {{ nextMonthName }} →
          </button>
        </div>

        <div
          class="dates-header"
          [style.transform]="
            config.viewMode === 'year'
              ? 'translateX(' + -scrollPosition + 'px)'
              : 'none'
          "
        >
          <!-- Cadre du mois en cours dans l'en-tête (vue année) -->
          <div
            class="month-frame-header"
            *ngIf="config.viewMode === 'year'"
            [style.left.px]="getMonthStartPosition(currentMonth)"
            [style.width.px]="getMonthWidth(currentMonth)"
          ></div>

          <!-- En-tête des mois (vue année) -->
          <div class="months-row" *ngIf="config.viewMode === 'year'">
            <div
              *ngFor="let month of months; let monthIndex = index"
              class="month-header-cell"
              [style.width.px]="getMonthWidth(monthIndex)"
              [title]="'Aller au mois de ' + month"
            >
              {{ month }}
            </div>
          </div>

          <!-- En-tête des noms des jours -->
          <div class="weekdays-row">
            <div
              *ngFor="let day of getAllDaysOfYear(); let dayIndex = index"
              [ngClass]="getWeekdayHeaderClass(dayIndex)"
              [style.width.px]="cellWidth"
            >
              {{ weekDays[day.getDay()] }}
            </div>
          </div>

          <!-- En-tête des jours -->
          <div class="days-row">
            <div
              *ngFor="let day of getAllDaysOfYear(); let dayIndex = index"
              [ngClass]="getDayHeaderClass(dayIndex)"
              [style.width.px]="cellWidth"
            >
              {{ day.getDate() }}
            </div>
          </div>
        </div>
      </div>

      <!-- En-tête colonne d'exportation (conditionnel) -->
      <div class="export-column-header" *ngIf="config.showExportButtons">
        <!-- Pas de texte pour une apparence plus discrète -->
      </div>
    </div>

    <!-- Lignes des employés avec scroll synchronisé -->
    <div class="employees-container">
      <div
        class="employee-row"
        *ngFor="let empCalendar of employeeCalendars"
        [ngClass]="getEmployeeRowClass(empCalendar.employee)"
      >
        <!-- Colonne employé (fixe) -->
        <div class="employee-info-fixed" [style.width.px]="employeeColumnWidth">
          <div class="employee-avatar">
            <img
              [src]="
                empCalendar.employee.profilePicture ||
                'assets/images/default-avatar.svg'
              "
              [alt]="
                empCalendar.employee.firstName +
                ' ' +
                empCalendar.employee.lastName
              "
            />
          </div>
          <div class="employee-details">
            <div class="employee-name">
              {{ empCalendar.employee.firstName }}
              {{ empCalendar.employee.lastName }}
            </div>
          </div>
        </div>

        <!-- Cellules de jours (scroll synchronisé) -->
        <div class="days-container-scrollable">
          <div
            class="days-wrapper"
            [style.transform]="
              config.viewMode === 'year'
                ? 'translateX(' + -scrollPosition + 'px)'
                : 'none'
            "
          >
            <!-- Cadre du mois en cours pour cette ligne (vue année) -->
            <div
              class="month-frame-row"
              *ngIf="config.viewMode === 'year'"
              [style.left.px]="getMonthStartPosition(currentMonth)"
              [style.width.px]="getMonthWidth(currentMonth)"
            ></div>

            <div
              *ngFor="let day of empCalendar.days; let dayIndex = index"
              [class]="getCellClass(day, empCalendar.employee, dayIndex)"
              [style.width.px]="cellWidth"
              [style.height.px]="cellHeight"
              (click)="onCellClick(day, empCalendar.employee, $event)"
              (dblclick)="
                onCellDoubleClick(day, empCalendar.employee, dayIndex, $event)
              "
              (mousedown)="onCellMouseDown(day, empCalendar.employee, $event)"
              (mouseenter)="onCellMouseEnter(day, empCalendar.employee)"
              (mouseup)="onCellMouseUp(day, empCalendar.employee, $event)"
            >
              <!-- Contenu de la cellule selon le mode -->
              <ng-container *ngIf="config.mode === 'leave-management'">
                <span *ngIf="day.status === 'worked'" class="day-indicator"
                  >1</span
                >
                <span
                  *ngIf="day.status === 'approved'"
                  class="approved-indicator"
                  >✓</span
                >
                <span *ngIf="day.status === 'pending'" class="pending-indicator"
                  >?</span
                >
                <span
                  *ngIf="day.status === 'rejected'"
                  class="rejected-indicator"
                  >✗</span
                >
                <span *ngIf="day.status === 'rtt'" class="rtt-indicator"
                  >R</span
                >
              </ng-container>

              <ng-container *ngIf="config.mode === 'cra'">
                <!-- Pour le CRA, afficher la valeur si elle existe -->
                <span
                  *ngIf="day.value !== undefined && day.value !== null"
                  class="cra-value"
                  >{{ day.value }}</span
                >
                <span *ngIf="day.status === 'holiday'" class="holiday-indicator"
                  >F</span
                >
                <span *ngIf="day.status === 'weekend'" class="weekend-indicator"
                  >-</span
                >
              </ng-container>
            </div>
          </div>
        </div>

        <!-- Colonne d'exportation (fixe à droite) - conditionnel -->
        <div class="export-column-fixed" *ngIf="config.showExportButtons">
          <button
            class="btn-export"
            (click)="openExportModal(empCalendar.employee, $event)"
            title="Exporter"
          >
            <svg
              width="12"
              height="12"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7,10 12,15 17,10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Scrollbar personnalisée en bas (vue année) -->
    <div class="custom-scrollbar" *ngIf="config.viewMode === 'year'">
      <div
        class="scrollbar-employee-placeholder"
        [style.width.px]="employeeColumnWidth"
      ></div>
      <div class="scrollbar-track">
        <div
          class="scrollbar-thumb"
          [style.width.%]="scrollThumbWidth"
          [style.left.%]="scrollThumbPosition"
          (mousedown)="onScrollbarMouseDown($event)"
        ></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal d'exportation -->
<div
  class="export-modal-overlay"
  *ngIf="showExportModal"
  (click)="closeExportModal()"
>
  <div class="export-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Exporter le CRA</h3>
      <button class="close-btn" (click)="closeExportModal()" title="Fermer">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="employee-info-export" *ngIf="selectedEmployeeForExport">
        <div class="export-employee-avatar">
          <img
            [src]="
              selectedEmployeeForExport.profilePicture ||
              'assets/images/default-avatar.svg'
            "
            [alt]="
              selectedEmployeeForExport.firstName +
              ' ' +
              selectedEmployeeForExport.lastName
            "
          />
        </div>
        <div class="export-employee-details">
          <h4>
            {{ selectedEmployeeForExport.firstName }}
            {{ selectedEmployeeForExport.lastName }}
          </h4>
          <p class="employee-department">
            {{ selectedEmployeeForExport.department }}
          </p>
          <p class="export-period">
            Période: {{ getMonthName(selectedMonth) }} {{ selectedYear }}
          </p>
        </div>
      </div>

      <div class="export-options">
        <h4>Choisissez le format d'exportation :</h4>

        <div class="export-format-grid">
          <button
            class="export-format-btn excel"
            (click)="exportEmployee('excel')"
          >
            <div class="format-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                <rect
                  x="3"
                  y="3"
                  width="18"
                  height="18"
                  rx="2"
                  ry="2"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <line
                  x1="9"
                  y1="9"
                  x2="15"
                  y2="15"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <line
                  x1="15"
                  y1="9"
                  x2="9"
                  y2="15"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </div>
            <div class="format-info">
              <span class="format-name">Excel (.xlsx)</span>
              <span class="format-description"
                >Tableau détaillé avec calculs</span
              >
            </div>
          </button>

          <button class="export-format-btn pdf" (click)="exportEmployee('pdf')">
            <div class="format-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                <path
                  d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                  fill="currentColor"
                />
              </svg>
            </div>
            <div class="format-info">
              <span class="format-name">PDF</span>
              <span class="format-description">Document prêt à imprimer</span>
            </div>
          </button>

          <button class="export-format-btn csv" (click)="exportEmployee('csv')">
            <div class="format-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                <path
                  d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                />
                <polyline
                  points="9,13 9,17"
                  stroke="currentColor"
                  stroke-width="1"
                />
                <polyline
                  points="11,13 11,17"
                  stroke="currentColor"
                  stroke-width="1"
                />
                <polyline
                  points="13,13 13,17"
                  stroke="currentColor"
                  stroke-width="1"
                />
              </svg>
            </div>
            <div class="format-info">
              <span class="format-name">CSV</span>
              <span class="format-description">Données tabulaires simples</span>
            </div>
          </button>

          <button
            class="export-format-btn json"
            (click)="exportEmployee('json')"
          >
            <div class="format-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                <path
                  d="M5 3h14c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2z"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                />
                <path
                  d="M8 8h8M8 12h8M8 16h4"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
              </svg>
            </div>
            <div class="format-info">
              <span class="format-name">JSON</span>
              <span class="format-description"
                >Format de données structurées</span
              >
            </div>
          </button>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeExportModal()">
        Annuler
      </button>
    </div>
  </div>
</div>
