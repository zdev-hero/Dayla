<div class="row mb-3 bord" aria-labelledby="titre-demandes">
  <div class="col-12">
    <div class="employee-table-card">
      <div class="card-header">
        <div class="header-top">
          <h2 class="card-title">Tableau des employés</h2>
        </div>

        <!-- Barre de recherche et filtres -->
        <div class="search-filter-bar">
          <div class="search-and-filters">
            <!-- Champ de recherche avec auto-complétion -->
            <div class="search-container">
              <div class="search-input-wrapper">
                <svg
                  class="search-icon"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="11" cy="11" r="8" />
                  <path d="m21 21-4.35-4.35" />
                </svg>
                <input
                  type="text"
                  class="search-input"
                  placeholder="Rechercher un employé..."
                  [(ngModel)]="searchQuery"
                  (input)="onSearchInput($event)"
                  (focus)="showSearchSuggestions = true"
                  (blur)="hideSearchSuggestions()"
                  autocomplete="off"
                />
                <button
                  *ngIf="searchQuery"
                  class="clear-search"
                  (click)="clearSearch()"
                  type="button"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                  </svg>
                </button>
              </div>

              <!-- Suggestions d'auto-complétion -->
              <div
                *ngIf="showSearchSuggestions && searchSuggestions.length > 0"
                class="search-suggestions"
              >
                <div
                  *ngFor="let suggestion of searchSuggestions"
                  class="suggestion-item"
                  (mousedown)="selectSuggestion(suggestion)"
                >
                  <img
                    [src]="
                      suggestion.profilePicture ||
                      'assets/images/default-avatar.svg'
                    "
                    [alt]="suggestion.firstName + ' ' + suggestion.lastName"
                    class="suggestion-avatar"
                  />
                  <div class="suggestion-info">
                    <span class="suggestion-name"
                      >{{ suggestion.firstName }}
                      {{ suggestion.lastName }}</span
                    >
                    <span class="suggestion-department">{{
                      suggestion.department
                    }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bouton filtres -->
            <button
              class="btn-filters"
              [class.active]="showFilters"
              (click)="toggleFilters()"
              title="Filtres"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46" />
              </svg>
              <span>Filtres</span>
              <span *ngIf="activeFiltersCount > 0" class="filter-badge">{{
                activeFiltersCount
              }}</span>
            </button>
          </div>

          <div class="action-buttons">
            <button
              class="btn-add-employee"
              title="Ajouter un nouvel employé"
              (click)="addNewEmployee()"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <line x1="19" y1="8" x2="19" y2="14" />
                <line x1="22" y1="11" x2="16" y2="11" />
              </svg>
              <span>Ajouter un employé</span>
            </button>
          </div>
        </div>

        <!-- Panel de filtres -->
        <div *ngIf="showFilters" class="filters-panel">
          <div class="filters-header">
            <h3>Filtres</h3>
            <button
              class="close-filters-btn"
              (click)="closeFilters()"
              title="Fermer les filtres"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>
          <div class="filters-content">
            <div class="filter-section">
              <h4>Département</h4>
              <div class="filter-options">
                <label
                  *ngFor="let dept of availableDepartments"
                  class="filter-checkbox"
                >
                  <input
                    type="checkbox"
                    [value]="dept"
                    [checked]="selectedFilters.departments.includes(dept)"
                    (change)="onDepartmentFilterChange(dept, $event)"
                  />
                  <span class="checkmark"></span>
                  {{ dept }}
                </label>
              </div>
            </div>

            <div class="filter-section">
              <h4>Type de contrat</h4>
              <div class="filter-options">
                <label
                  *ngFor="let type of availableContractTypes"
                  class="filter-checkbox"
                >
                  <input
                    type="checkbox"
                    [value]="type"
                    [checked]="selectedFilters.contractTypes.includes(type)"
                    (change)="onContractTypeFilterChange(type, $event)"
                  />
                  <span class="checkmark"></span>
                  {{ type }}
                </label>
              </div>
            </div>

            <div class="filter-section">
              <h4>Secteur d'activité</h4>
              <div class="filter-options">
                <label
                  *ngFor="let sector of availableWorkSectors"
                  class="filter-checkbox"
                >
                  <input
                    type="checkbox"
                    [value]="sector"
                    [checked]="selectedFilters.workSectors.includes(sector)"
                    (change)="onWorkSectorFilterChange(sector, $event)"
                  />
                  <span class="checkmark"></span>
                  {{ getWorkSectorDisplayName(sector) }}
                </label>
              </div>
            </div>

            <div class="filter-section">
              <h4>Statut</h4>
              <div class="filter-options">
                <label class="filter-checkbox">
                  <input
                    type="checkbox"
                    [checked]="selectedFilters.activeOnly"
                    (change)="onActiveFilterChange($event)"
                  />
                  <span class="checkmark"></span>
                  Employés actifs seulement
                </label>
                <label class="filter-checkbox">
                  <input
                    type="checkbox"
                    [checked]="selectedFilters.contractExpiringSoon"
                    (change)="onExpiringContractFilterChange($event)"
                  />
                  <span class="checkmark"></span>
                  Contrats expirant bientôt
                </label>
              </div>
            </div>

            <div class="filter-actions">
              <button class="btn-clear-filters" (click)="clearAllFilters()">
                Effacer les filtres
              </button>
              <button class="btn-apply-filters" (click)="applyFilters()">
                Appliquer ({{ filteredEmployeesCount }} résultats)
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Indicateur de chargement -->
      <div *ngIf="loading" class="loading-indicator">
        <div class="spinner"></div>
        <p>Chargement des employés...</p>
      </div>

      <!-- Contenu principal -->
      <div *ngIf="!loading" class="table-container">
        <table class="employee-table">
          <thead>
            <tr>
              <th class="col-select"></th>
              <th class="col-user">Employé</th>
              <th class="col-hire-date">Date d'embauche</th>
              <th class="col-contract">Type de contrat</th>
              <th class="col-end-date">Fin de contrat</th>
              <th class="col-department">Département</th>
              <th class="col-sector">Secteur</th>
              <th class="col-action">Actions</th>
            </tr>
          </thead>
          <tbody>
            <ng-container
              *ngFor="
                let employee of employees;
                let i = index;
                trackBy: trackByEmployeeId
              "
            >
              <!-- Ligne principale -->
              <tr class="table-row">
                <td class="select-cell">
                  <div class="select-container">
                    <input
                      type="checkbox"
                      class="row-checkbox"
                      (change)="onRowSelect(i, $event)"
                    />
                    <div class="vertical-line"></div>
                  </div>
                </td>
                <td class="user-cell">
                  <div class="user-info" (click)="onUserClick(i, $event)">
                    <div
                      class="min-user-avatar"
                      [class]="getUserAvatarClass(employee)"
                    >
                      <img
                        [src]="
                          employee.profilePicture ||
                          'assets/images/default-avatar.svg'
                        "
                        [alt]="'Avatar de ' + getFullName(employee)"
                        class="avatar-image-small"
                        (error)="handleImageError($event)"
                      />
                    </div>
                    <div class="user-details">
                      <div class="user-name">{{ getFullName(employee) }}</div>
                      <div class="user-email">
                        {{ employee.email || "N/A" }}
                      </div>
                    </div>
                  </div>
                </td>
                <td>{{ formatDate(employee.hireDate) }}</td>
                <td>
                  <span
                    class="contract-chip"
                    [class]="getContractStatusClass(employee)"
                  >
                    {{ getContractTypeLabel(employee.contractType) }}
                  </span>
                </td>
                <td>{{ formatDate(employee.contractEndDate) }}</td>
                <td>{{ employee.department || "N/A" }}</td>
                <td>{{ getWorkSectorLabel(employee.workSector) }}</td>
                <td>
                  <div
                    class="action-buttons-container"
                    [class.expanded]="expandedActionRows.has(i)"
                  >
                    <!-- Bouton "Tous les documents" par défaut -->
                    <div
                      class="default-action"
                      [class.hidden]="expandedActionRows.has(i)"
                    >
                      <button
                        class="action-btn more"
                        title="Tous les documents"
                        (click)="toggleActionMenu(i, $event)"
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <circle cx="12" cy="12" r="1" />
                          <circle cx="12" cy="5" r="1" />
                          <circle cx="12" cy="19" r="1" />
                        </svg>
                      </button>
                    </div>

                    <!-- Menu d'actions détaillées -->
                    <div
                      class="expanded-actions"
                      [class.visible]="expandedActionRows.has(i)"
                    >
                      <button
                        class="action-btn contract"
                        title="Voir le contrat"
                        (click)="viewDocuments(employee, 'contract')"
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path
                            d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                          />
                          <polyline points="14,2 14,8 20,8" />
                          <line x1="16" y1="13" x2="8" y2="13" />
                          <line x1="16" y1="17" x2="8" y2="17" />
                          <polyline points="10,9 9,9 8,9" />
                        </svg>
                      </button>
                      <button
                        class="action-btn payslip"
                        title="Voir les fiches de paie"
                        (click)="viewDocuments(employee, 'payslip')"
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <rect
                            x="3"
                            y="3"
                            width="18"
                            height="18"
                            rx="2"
                            ry="2"
                          />
                          <circle cx="8.5" cy="8.5" r="1.5" />
                          <path d="M21 15l-5-5L5 21" />
                        </svg>
                      </button>
                      <button
                        class="action-btn justification"
                        title="Voir les justificatifs"
                        (click)="viewDocuments(employee, 'justification')"
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path
                            d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"
                          />
                          <polyline points="13,2 13,9 20,9" />
                        </svg>
                      </button>
                      <button
                        class="action-btn edit"
                        title="Modifier l'employé"
                        (click)="openEditModal(employee)"
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path d="m18 2 4 4-12 12H6v-4z" />
                          <path d="m21.5 6.5-3.5-3.5M2 18h3l12-12" />
                        </svg>
                      </button>
                      <button
                        class="action-btn close"
                        title="Fermer"
                        (click)="toggleActionMenu(i, $event)"
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <line x1="18" y1="6" x2="6" y2="18"></line>
                          <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                      </button>
                    </div>
                  </div>
                </td>
              </tr>

              <!-- Ligne étendue avec détails de l'employé -->
              <tr *ngIf="isRowExpanded(i)" class="expanded-row">
                <td colspan="8" class="expanded-content">
                  <div class="employee-details">
                    <div class="row">
                      <div class="col-md-3">
                        <div class="detail-section">
                          <h4>Informations personnelles</h4>
                          <div class="detail-item">
                            <span class="label">Téléphone:</span>
                            <span class="value">{{
                              employee.phone || "N/A"
                            }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Poste:</span>
                            <span class="value">{{ employee.position }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Statut:</span>
                            <span
                              class="value"
                              [class]="
                                employee.isActive
                                  ? 'active-status'
                                  : 'inactive-status'
                              "
                            >
                              {{ employee.isActive ? "Actif" : "Inactif" }}
                            </span>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="detail-section">
                          <h4>Contrat</h4>
                          <div class="detail-item">
                            <span class="label">Type:</span>
                            <span class="value">{{
                              getContractTypeLabel(employee.contractType)
                            }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Début:</span>
                            <span class="value">{{
                              formatDate(employee.hireDate)
                            }}</span>
                          </div>
                          <div class="detail-item">
                            <span class="label">Fin:</span>
                            <span class="value">{{
                              formatDate(employee.contractEndDate)
                            }}</span>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="detail-section">
                          <h4>Congés</h4>
                          <div class="detail-item">
                            <span class="label">Vacances:</span>
                            <span class="value"
                              >{{ employee.leaveBalance.vacation }} jours</span
                            >
                          </div>
                          <div class="detail-item">
                            <span class="label">Maladie:</span>
                            <span class="value"
                              >{{ employee.leaveBalance.sick }} jours</span
                            >
                          </div>
                          <div class="detail-item">
                            <span class="label">Utilisés:</span>
                            <span class="value"
                              >{{
                                employee.leaveBalance.totalDaysUsed
                              }}
                              jours</span
                            >
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="detail-section">
                          <h4>Documents</h4>
                          <div class="detail-item">
                            <span class="label">Total:</span>
                            <span class="value"
                              >{{
                                employee.documents?.length || 0
                              }}
                              document(s)</span
                            >
                          </div>
                          <div class="detail-item">
                            <span class="label">Salaire:</span>
                            <span class="value">{{
                              employee.salary ? employee.salary + " €" : "N/A"
                            }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>

        <!-- Message si aucun employé -->
        <div *ngIf="employees.length === 0" class="no-employees">
          <p>Aucun employé trouvé.</p>
        </div>
      </div>

      <!-- Footer avec pagination -->
      <div *ngIf="!loading" class="table-footer">
        <div class="table-controls">
          <div class="table-info">
            Affichage de {{ (currentPage - 1) * pageSize + 1 }}–{{
              Math.min(currentPage * pageSize, totalEmployees)
            }}
            sur {{ totalEmployees }} employés
          </div>

          <div class="page-size-selector" *ngIf="availablePageSizes.length > 1">
            <label for="pageSize" class="form-label">Afficher :</label>
            <select
              id="pageSize"
              [(ngModel)]="pageSize"
              (change)="onPageSizeChange()"
              class="form-select form-select-sm page-size-select"
            >
              <option *ngFor="let size of availablePageSizes" [value]="size">
                {{ size }} par page
              </option>
            </select>
          </div>
        </div>

        <div class="pagination" *ngIf="totalPages > 1">
          <button
            class="pagination-btn"
            [disabled]="currentPage === 1"
            (click)="previousPage()"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="15,18 9,12 15,6" />
            </svg>
          </button>

          <button
            *ngFor="let page of pages; trackBy: trackByPageNumber"
            class="pagination-btn page-number"
            [class.active]="page === currentPage"
            (click)="changePage(page)"
          >
            {{ page }}
          </button>

          <button
            class="pagination-btn"
            [disabled]="currentPage === totalPages"
            (click)="nextPage()"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="9,18 15,12 9,6" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
