<div class="absence-table-card">
  <div class="card-header">
    <div class="filters">
      <select
        class="filter-select"
        (change)="onTypeFilterChange($any($event.target).value)"
        [value]="selectedType"
      >
        <option value="all">Tous les types</option>
        <option value="vacation">Congé payé</option>
        <option value="sick_leave">Arrêt maladie</option>
        <option value="rtt">RTT</option>
        <option value="unpaid_leave">Congé sans solde</option>
        <option value="maternity">Congé maternité</option>
        <option value="paternity">Congé paternité</option>
        <option value="training">Formation</option>
        <option value="other">Autre</option>
      </select>

      <select
        class="filter-select"
        (change)="onStatusFilterChange($any($event.target).value)"
        [value]="selectedStatus"
      >
        <option value="all">Tous les statuts</option>
        <option value="current">En cours</option>
        <option value="ending_soon">Fin prochaine</option>
        <option value="starting_soon">Début prochain</option>
      </select>
    </div>
  </div>

  <!-- Indicateur de chargement -->
  <div *ngIf="loading" class="loading-indicator">
    <div class="spinner"></div>
    <p>Chargement des absences...</p>
  </div>

  <!-- Contenu principal -->
  <div *ngIf="!loading" class="table-container">
    <table class="absence-table">
      <thead>
        <tr>
          <th class="col-select">
            <!-- <div class="select-header">
              <input
                type="checkbox"
                class="select-all-checkbox"
                (change)="onSelectAll($event)"
              />
              <div class="vertical-line"></div>
            </div> -->
          </th>
          <th class="col-user">Employé</th>
          <th class="col-type">Type d'absence</th>
          <th class="col-date-start">Date de début</th>
          <th class="col-date-end">Date de fin</th>
          <th class="col-duration">Durée</th>
          <th class="col-remaining">Jours restants</th>
          <th class="col-status">Statut</th>
          <th class="col-action">Action</th>
        </tr>
      </thead>
      <tbody>
        <ng-container
          *ngFor="
            let absence of absences;
            let i = index;
            trackBy: trackByAbsenceId
          "
        >
          <!-- Ligne principale -->
          <tr class="table-row">
            <td class="select-cell">
              <div class="select-container" [class.pr-0]="i === 0">
                <input
                  type="checkbox"
                  class="row-checkbox"
                  (change)="onRowSelect(i, $event)"
                />
                <div class="vertical-line"></div>
              </div>
            </td>
            <td class="user-cell">
              <div class="user-info" (click)="onUserClick(i, $event)">
                <div
                  class="min-user-avatar"
                  [class]="getUserAvatarClass(absence)"
                >
                  <img
                    [src]="
                      absence.employee.profilePicture ||
                      'assets/images/default-avatar.svg'
                    "
                    [alt]="'Avatar de ' + getFullName(absence)"
                    class="avatar-image"
                    (error)="handleImageError($event)"
                  />
                </div>
                <div class="user-details">
                  <div class="user-name">{{ getFullName(absence) }}</div>
                  <div class="user-email">
                    {{ absence.employee.email || "N/A" }}
                  </div>
                  <div class="user-department">
                    {{ absence.employee.department || "N/A" }}
                  </div>
                </div>
              </div>
            </td>
            <td class="type-cell">
              <div class="type-info">
                <img
                  [src]="getTypeIcon(absence.type)"
                  [alt]="ABSENCE_TYPE_LABELS[absence.type]"
                  class="type-icon"
                />
                <span class="type-label" [class]="getTypeClass(absence.type)">
                  {{ ABSENCE_TYPE_LABELS[absence.type] }}
                </span>
              </div>
            </td>
            <td>{{ formatDate(absence.startDate) }}</td>
            <td>{{ formatDate(absence.endDate) }}</td>
            <td>{{ getDurationText(absence.totalDays) }}</td>
            <td class="remaining-cell">
              <span
                class="remaining-days"
                [class]="getRemainingDaysClass(absence)"
              >
                {{ getRemainingDaysText(absence) }}
              </span>
            </td>
            <td>
              <span
                class="status-chip d-flex align-items-center justify-content-center"
                [class]="getStatusClass(absence.status)"
              >
                <img
                  [src]="getStatusIcon(absence.status)"
                  [alt]="ABSENCE_STATUS_LABELS[absence.status]"
                  class="status-icon"
                />
                {{ ABSENCE_STATUS_LABELS[absence.status] }}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="action-btn edit"
                  title="Modifier l'employé"
                  (click)="openEditModal(absence.employee!)"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="m18 2 4 4-12 12H6v-4z" />
                    <path d="m21.5 6.5-3.5-3.5M2 18h3l12-12" />
                  </svg>
                </button>
                <button class="action-btn more" title="Plus d'options">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <circle cx="12" cy="12" r="1" />
                    <circle cx="12" cy="5" r="1" />
                    <circle cx="12" cy="19" r="1" />
                  </svg>
                </button>
              </div>
            </td>
          </tr>

          <!-- Ligne étendue avec informations d'employé -->
          <tr *ngIf="isRowExpanded(i)" class="expanded-row">
            <td colspan="9" class="expanded-content">
              <div class="row">
                <div class="col-lg-8 border-end-section">
                  <app-employee-dashboard
                    [employee]="selectedEmployee"
                  ></app-employee-dashboard>
                </div>
                <div class="col-lg-4">
                  <app-leave-analytics
                    [employee]="selectedEmployee"
                  ></app-leave-analytics>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>

    <!-- Message si aucune absence -->
    <div *ngIf="absences.length === 0" class="no-absences">
      <p>Aucune absence trouvée.</p>
    </div>
  </div>

  <!-- Footer avec pagination -->
  <div *ngIf="!loading" class="table-footer">
    <div class="table-info">
      Affichage de {{ (currentPage - 1) * pageSize + 1 }}–{{
        Math.min(currentPage * pageSize, totalAbsences)
      }}
      sur {{ totalAbsences }} absences
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
      <button
        class="pagination-btn"
        [disabled]="currentPage === 1"
        (click)="previousPage()"
      >
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="15,18 9,12 15,6" />
        </svg>
      </button>

      <button
        *ngFor="let page of pages; trackBy: trackByPageNumber"
        class="pagination-btn page-number"
        [class.active]="page === currentPage"
        (click)="changePage(page)"
      >
        {{ page }}
      </button>

      <button
        class="pagination-btn"
        [disabled]="currentPage === totalPages"
        (click)="nextPage()"
      >
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="9,18 15,12 9,6" />
        </svg>
      </button>
    </div>
  </div>
</div>
