<div class="calendar-container">
  <!-- Header avec filtres -->
  <header class="calendar-header">
    <div class="header-top">
      <h1 class="page-title">Calendrier des cong√©s</h1>
      <div class="view-controls">
        <select
          [(ngModel)]="viewMode"
          (change)="onFilterChange()"
          class="view-selector"
        >
          <option value="year">Vue annuelle</option>
          <option value="quarter">Vue trimestrielle</option>
          <option value="month">Vue mensuelle</option>
        </select>
      </div>
    </div>

    <div class="filters-row">
      <!-- S√©lecteur d'ann√©e -->
      <div class="filter-group">
        <label>Ann√©e</label>
        <select
          [(ngModel)]="selectedYear"
          (change)="onYearChange()"
          class="year-selector"
        >
          <option [value]="selectedYear - 1">{{ selectedYear - 1 }}</option>
          <option [value]="selectedYear">{{ selectedYear }}</option>
          <option [value]="selectedYear + 1">{{ selectedYear + 1 }}</option>
        </select>
      </div>

      <!-- P√©riode sp√©cifique -->
      <div class="filter-group" *ngIf="viewMode === 'quarter'">
        <label>Trimestre</label>
        <select [(ngModel)]="selectedQuarter" (change)="onFilterChange()">
          <option value="1">Q1 (Jan-Mar)</option>
          <option value="2">Q2 (Avr-Juin)</option>
          <option value="3">Q3 (Juil-Sep)</option>
          <option value="4">Q4 (Oct-D√©c)</option>
        </select>
      </div>

      <div class="filter-group" *ngIf="viewMode === 'month'">
        <label>Mois</label>
        <select [(ngModel)]="selectedMonth" (change)="onFilterChange()">
          <option *ngFor="let month of months; let i = index" [value]="i + 1">
            {{ month }}
          </option>
        </select>
      </div>

      <!-- Filtres -->
      <div class="filter-group">
        <label>√âquipe</label>
        <select [(ngModel)]="selectedTeam" (change)="onFilterChange()">
          <option value="">Toutes les √©quipes</option>
          <option *ngFor="let team of teams" [value]="team">{{ team }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Employ√©</label>
        <select [(ngModel)]="selectedEmployee" (change)="onFilterChange()">
          <option value="">Tous les employ√©s</option>
          <option *ngFor="let employee of employees" [value]="employee.id">
            {{ employee.firstName }} {{ employee.lastName }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label>Type de cong√©</label>
        <select [(ngModel)]="selectedLeaveType" (change)="onFilterChange()">
          <option value="">Tous les types</option>
          <option *ngFor="let type of leaveTypes" [value]="type">
            {{ getLeaveTypeLabel(type) }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label>Statut</label>
        <select [(ngModel)]="selectedStatus" (change)="onFilterChange()">
          <option value="">Tous les statuts</option>
          <option *ngFor="let status of leaveStatuses" [value]="status">
            {{ getLeaveStatusLabel(status) }}
          </option>
        </select>
      </div>
    </div>

    <!-- L√©gende -->
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color status-worked"></div>
        <span>Travaill√©</span>
      </div>
      <div class="legend-item">
        <div class="legend-color status-approved"></div>
        <span>Cong√© valid√©</span>
      </div>
      <div class="legend-item">
        <div class="legend-color status-pending"></div>
        <span>En attente</span>
      </div>
      <div class="legend-item">
        <div class="legend-color status-rejected"></div>
        <span>Refus√©</span>
      </div>
      <div class="legend-item">
        <div class="legend-color status-rtt"></div>
        <span>RTT</span>
      </div>
      <div class="legend-item">
        <div class="legend-color status-holiday"></div>
        <span>Jour f√©ri√©</span>
      </div>
      <div class="legend-item">
        <div class="legend-color status-weekend"></div>
        <span>Week-end</span>
      </div>
    </div>
  </header>

  <!-- Barre d'outils pour la s√©lection multiple -->
  <div class="selection-toolbar" *ngIf="isMultiSelectMode">
    <div class="toolbar-info">
      <span class="selection-count"
        >{{ selectedCells.size }} cellule(s) s√©lectionn√©e(s)</span
      >
    </div>
    <div class="toolbar-actions">
      <button
        class="btn btn-primary"
        (click)="openBulkManagementPopup()"
        [disabled]="selectedCells.size === 0"
      >
        <i class="icon-settings"></i> G√©rer la s√©lection
      </button>
      <button class="btn btn-secondary" (click)="clearSelection()">
        <i class="icon-clear"></i> Effacer la s√©lection
      </button>
    </div>
  </div>

  <!-- Tableau calendrier -->
  <div class="calendar-table-wrapper">
    <!-- En-t√™te avec les dates/mois -->
    <div class="calendar-header-sticky">
      <div class="employee-column-header">
        <span>Employ√©s</span>

        <!-- Champ de recherche d'employ√©s -->
        <div class="employee-search">
          <div class="search-input-container">
            <input
              type="text"
              [(ngModel)]="employeeSearchTerm"
              (input)="onEmployeeSearch()"
              placeholder="Rechercher un employ√©..."
              class="employee-search-input"
            />
            <button
              *ngIf="employeeSearchTerm"
              (click)="clearEmployeeSearch()"
              class="clear-search-btn"
              title="Effacer la recherche"
            >
              ‚úï
            </button>
          </div>

          <!-- Liste d'autocompl√©tion -->
          <div class="autocomplete-list" *ngIf="filteredEmployees.length > 0">
            <div
              *ngFor="let employee of filteredEmployees"
              class="autocomplete-item"
              (click)="selectEmployee(employee)"
            >
              <div class="employee-info">
                <span class="employee-name"
                  >{{ employee.firstName }} {{ employee.lastName }}</span
                >
                <span class="employee-dept"
                  >{{ employee.department }} - {{ employee.position }}</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="dates-header-container" #datesHeaderContainer>
        <!-- Bouton mois pr√©c√©dent √† gauche -->
        <div class="scroll-controls-left">
          <button
            class="scroll-btn scroll-left"
            (click)="scrollToPreviousMonth()"
            [disabled]="!canScrollLeft"
          >
            ‚Üê {{ previousMonthName }}
          </button>
        </div>
        <!-- Bouton mois suivant √† droite -->
        <div class="scroll-controls-right">
          <button
            class="scroll-btn scroll-right"
            (click)="scrollToNextMonth()"
            [disabled]="!canScrollRight"
          >
            {{ nextMonthName }} ‚Üí
          </button>
        </div>
        <div
          class="dates-header"
          [style.transform]="'translateX(' + -scrollPosition + 'px)'"
        >
          <!-- Cadre du mois en cours dans l'en-t√™te -->
          <div
            class="month-frame-header"
            [style.left.px]="getMonthStartPosition(currentMonth)"
            [style.width.px]="getMonthWidth(currentMonth)"
          ></div>

          <!-- En-t√™te des mois -->
          <div class="months-row">
            <div
              *ngFor="let month of months; let monthIndex = index"
              class="month-header-cell"
              [style.width.px]="getMonthWidth(monthIndex)"
              (click)="scrollToMonth(monthIndex)"
              [title]="'Aller au mois de ' + month"
            >
              {{ month }}
            </div>
          </div>
          <!-- En-t√™te des noms des jours -->
          <div class="weekdays-row">
            <div
              *ngFor="let day of getAllDaysOfYear(); let dayIndex = index"
              [ngClass]="getWeekdayHeaderClass(dayIndex)"
            >
              {{ weekDays[day.getDay()] }}
            </div>
          </div>
          <!-- En-t√™te des jours -->
          <div class="days-row">
            <div
              *ngFor="let day of getAllDaysOfYear(); let dayIndex = index"
              [ngClass]="getDayHeaderClass(dayIndex)"
            >
              {{ day.getDate() }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lignes des employ√©s avec scroll synchronis√© -->
    <div class="employees-container">
      <div
        class="employee-row"
        *ngFor="let empCalendar of employeeCalendars"
        [ngClass]="getEmployeeRowClass(empCalendar.employee)"
      >
        <!-- Colonne employ√© (fixe) -->
        <div class="employee-info-fixed">
          <div class="employee-avatar">
            <img
              [src]="
                empCalendar.employee.profilePicture ||
                'assets/images/default-avatar.svg'
              "
              [alt]="
                empCalendar.employee.firstName +
                ' ' +
                empCalendar.employee.lastName
              "
            />
          </div>
          <div class="employee-details">
            <div class="employee-name">
              {{ empCalendar.employee.firstName }}
              {{ empCalendar.employee.lastName }}
            </div>
          </div>
        </div>

        <!-- Cellules de jours (scroll synchronis√©) -->
        <div class="days-container-scrollable">
          <div
            class="days-wrapper"
            [style.transform]="'translateX(' + -scrollPosition + 'px)'"
          >
            <!-- Cadre du mois en cours pour cette ligne -->
            <div
              class="month-frame-row"
              [style.left.px]="getMonthStartPosition(currentMonth)"
              [style.width.px]="getMonthWidth(currentMonth)"
            ></div>

            <div
              *ngFor="let day of empCalendar.days; let dayIndex = index"
              [class]="getCellClass(day, empCalendar.employee, dayIndex)"
              (click)="onCellClick(day, empCalendar.employee, $event)"
              (mousedown)="onCellMouseDown(day, empCalendar.employee, $event)"
              (mouseenter)="onCellMouseEnter(day, empCalendar.employee)"
              (mouseup)="onCellMouseUp(day, empCalendar.employee, $event)"
            >
              <!-- Contenu de la cellule selon le statut -->
              <span *ngIf="day.status === 'worked'" class="day-indicator"
                >1</span
              >
              <span *ngIf="day.status === 'approved'" class="approved-indicator"
                >‚úì</span
              >
              <span *ngIf="day.status === 'pending'" class="pending-indicator"
                >?</span
              >
              <span *ngIf="day.status === 'rejected'" class="rejected-indicator"
                >‚úó</span
              >
              <span *ngIf="day.status === 'rtt'" class="rtt-indicator">R</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scrollbar personnalis√©e en bas -->
    <div class="custom-scrollbar">
      <div class="scrollbar-employee-placeholder"></div>
      <div class="scrollbar-track">
        <div
          class="scrollbar-thumb"
          [style.width.%]="scrollThumbWidth"
          [style.left.%]="scrollThumbPosition"
          (mousedown)="onScrollbarMouseDown($event)"
        ></div>
      </div>
    </div>
  </div>

  <!-- Popup de gestion group√©e -->
  <div
    class="popup-overlay"
    *ngIf="showBulkManagementPopup"
    (click)="closeBulkManagementPopup()"
  >
    <div class="bulk-management-popup" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>Gestion group√©e des cong√©s</h3>
        <button class="close-btn" (click)="closeBulkManagementPopup()">
          &times;
        </button>
      </div>

      <div class="popup-body">
        <div class="selection-summary">
          <p>
            <strong>{{ selectedCells.size }}</strong> cellule(s) s√©lectionn√©e(s)
          </p>
          <div class="selection-breakdown" *ngIf="selectedDays.length > 0">
            <div class="breakdown-item" *ngIf="getStatusCount('pending') > 0">
              <span class="status-badge status-pending"
                >{{ getStatusCount("pending") }} En attente</span
              >
            </div>
            <div class="breakdown-item" *ngIf="getStatusCount('approved') > 0">
              <span class="status-badge status-approved"
                >{{ getStatusCount("approved") }} Valid√©</span
              >
            </div>
            <div class="breakdown-item" *ngIf="getStatusCount('rtt') > 0">
              <span class="status-badge status-rtt"
                >{{ getStatusCount("rtt") }} RTT</span
              >
            </div>
            <div class="breakdown-item" *ngIf="getStatusCount('rejected') > 0">
              <span class="status-badge status-rejected"
                >{{ getStatusCount("rejected") }} Refus√©</span
              >
            </div>
            <div class="breakdown-item" *ngIf="getStatusCount('worked') > 0">
              <span class="status-badge status-worked"
                >{{ getStatusCount("worked") }} Libre</span
              >
            </div>
          </div>
        </div>

        <!-- Actions pour demandes en attente -->
        <div class="action-group" *ngIf="getStatusCount('pending') > 0">
          <h4>Actions pour les demandes en attente</h4>
          <div class="action-buttons">
            <button class="btn btn-approve" (click)="bulkApprove()">
              ‚úì Valider toutes ({{ getStatusCount("pending") }})
            </button>
            <button
              class="btn btn-reject"
              (click)="bulkReject()"
              [disabled]="!bulkRejectionReason.trim()"
            >
              ‚úó Refuser toutes ({{ getStatusCount("pending") }})
            </button>
          </div>
          <div class="form-group">
            <label for="bulkRejectionReason">Motif de refus :</label>
            <textarea
              id="bulkRejectionReason"
              [(ngModel)]="bulkRejectionReason"
              placeholder="Indiquez le motif du refus..."
              rows="2"
              class="form-control"
            ></textarea>
          </div>
        </div>

        <!-- Actions pour cong√©s valid√©s -->
        <div
          class="action-group"
          *ngIf="getStatusCount('approved') > 0 || getStatusCount('rtt') > 0"
        >
          <h4>Modifier les cong√©s valid√©s</h4>

          <div class="selected-dates-info">
            <strong>Dates concern√©es :</strong> {{ getSelectedDatesText() }}
          </div>

          <div class="form-group">
            <label for="bulkLeaveType">Type de cong√© :</label>
            <select
              id="bulkLeaveType"
              [(ngModel)]="bulkLeaveType"
              class="form-control"
            >
              <option *ngFor="let type of leaveTypes" [value]="type">
                {{ getLeaveTypeLabel(type) }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="bulkReason">Motif :</label>
            <textarea
              id="bulkReason"
              [(ngModel)]="bulkReason"
              placeholder="Nouveau motif..."
              rows="2"
              class="form-control"
            ></textarea>
          </div>
          <button class="btn btn-primary" (click)="bulkModify()">
            ‚úèÔ∏è Modifier tous ({{
              getStatusCount("approved") + getStatusCount("rtt")
            }})
          </button>
        </div>

        <!-- Actions pour cellules libres -->
        <div class="action-group" *ngIf="getStatusCount('worked') > 0">
          <h4>Affecter des cong√©s</h4>

          <div class="selected-dates-info">
            <strong>Dates concern√©es :</strong> {{ getSelectedDatesText() }}
          </div>

          <div class="form-group">
            <label for="assignLeaveType">Type de cong√© :</label>
            <select
              id="assignLeaveType"
              [(ngModel)]="bulkLeaveType"
              class="form-control"
            >
              <option *ngFor="let type of leaveTypes" [value]="type">
                {{ getLeaveTypeLabel(type) }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="assignReason">Motif :</label>
            <textarea
              id="assignReason"
              [(ngModel)]="bulkReason"
              placeholder="Motif des cong√©s..."
              rows="2"
              class="form-control"
            ></textarea>
          </div>

          <div class="action-buttons">
            <button
              class="btn btn-success"
              (click)="bulkAssign()"
              [disabled]="!bulkReason.trim()"
            >
              ‚úì Valider et affecter ({{ getStatusCount("worked") }} cellules)
            </button>
            <button
              class="btn btn-warning"
              (click)="bulkCreatePending()"
              [disabled]="!bulkReason.trim()"
            >
              üìù Cr√©er demande en attente ({{ getStatusCount("worked") }}
              cellules)
            </button>
          </div>
        </div>
      </div>

      <div class="popup-footer">
        <button class="btn btn-secondary" (click)="closeBulkManagementPopup()">
          Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Popup de d√©tails pour les demandes en attente -->
  <div
    class="popup-overlay"
    *ngIf="showDetailsPopup"
    (click)="closeDetailsPopup()"
  >
    <div class="popup-content" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>
          {{
            isEditingLeave
              ? "Modifier la demande de cong√©"
              : "D√©tails de la demande de cong√©"
          }}
        </h3>
        <button class="close-btn" (click)="closeDetailsPopup()">&times;</button>
      </div>

      <div class="popup-body" *ngIf="selectedLeaveRequest">
        <!-- Mode lecture -->
        <div class="request-info" *ngIf="!isEditingLeave">
          <div class="info-row">
            <label>Employ√© :</label>
            <span
              >{{ selectedLeaveRequest.employee?.firstName }}
              {{ selectedLeaveRequest.employee?.lastName }}</span
            >
          </div>
          <div class="info-row">
            <label>Type de cong√© :</label>
            <span>{{ getLeaveTypeLabel(selectedLeaveRequest.leaveType) }}</span>
          </div>
          <div class="info-row">
            <label>P√©riode :</label>
            <span>
              Du {{ formatDate(selectedLeaveRequest.startDate) }} au
              {{ formatDate(selectedLeaveRequest.endDate) }}
            </span>
          </div>
          <div class="info-row">
            <label>Nombre de jours :</label>
            <span>{{ selectedLeaveRequest.totalDays }} jour(s)</span>
          </div>
          <div class="info-row">
            <label>Motif :</label>
            <span>{{ selectedLeaveRequest.reason }}</span>
          </div>
          <div class="info-row">
            <label>Date de demande :</label>
            <span>{{ formatDate(selectedLeaveRequest.submittedDate) }}</span>
          </div>
          <div class="info-row">
            <label>Statut :</label>
            <span
              class="status-badge"
              [ngClass]="{
                'status-pending': selectedLeaveRequest.status === 'pending',
                'status-approved': selectedLeaveRequest.status === 'approved',
                'status-rejected': selectedLeaveRequest.status === 'rejected'
              }"
            >
              {{ getLeaveStatusLabel(selectedLeaveRequest.status) }}
            </span>
          </div>
          <div class="info-row" *ngIf="selectedLeaveRequest.comments">
            <label>Commentaires :</label>
            <span>{{ selectedLeaveRequest.comments }}</span>
          </div>
        </div>

        <!-- Mode √©dition -->
        <div
          class="request-edit"
          *ngIf="isEditingLeave && editableLeaveRequest"
        >
          <div class="edit-row">
            <label>Employ√© :</label>
            <span
              >{{ editableLeaveRequest.employee?.firstName }}
              {{ editableLeaveRequest.employee?.lastName }}</span
            >
          </div>
          <div class="edit-row">
            <label for="editLeaveType">Type de cong√© :</label>
            <select
              id="editLeaveType"
              [(ngModel)]="editableLeaveRequest.leaveType"
              class="edit-select"
            >
              <option *ngFor="let type of leaveTypes" [value]="type">
                {{ getLeaveTypeLabel(type) }}
              </option>
            </select>
          </div>
          <div class="edit-row">
            <label for="editStartDate">Date de d√©but :</label>
            <input
              id="editStartDate"
              type="date"
              [(ngModel)]="editableLeaveRequest.startDate"
              class="edit-input"
            />
          </div>
          <div class="edit-row">
            <label for="editEndDate">Date de fin :</label>
            <input
              id="editEndDate"
              type="date"
              [(ngModel)]="editableLeaveRequest.endDate"
              class="edit-input"
            />
          </div>
          <div class="edit-row">
            <label for="editReason">Motif :</label>
            <textarea
              id="editReason"
              [(ngModel)]="editableLeaveRequest.reason"
              rows="3"
              class="edit-textarea"
            ></textarea>
          </div>
          <div class="edit-row">
            <label for="editStatus">Statut :</label>
            <select
              id="editStatus"
              [(ngModel)]="editableLeaveRequest.status"
              class="edit-select"
            >
              <option [value]="leaveStatuses[0]">
                {{ getLeaveStatusLabel(leaveStatuses[0]) }}
              </option>
              <option [value]="leaveStatuses[1]">
                {{ getLeaveStatusLabel(leaveStatuses[1]) }}
              </option>
              <option [value]="leaveStatuses[2]">
                {{ getLeaveStatusLabel(leaveStatuses[2]) }}
              </option>
            </select>
          </div>
          <div
            class="edit-row"
            *ngIf="editableLeaveRequest.status === leaveStatuses[2]"
          >
            <label for="editComments">Motif de refus :</label>
            <textarea
              id="editComments"
              [(ngModel)]="tempRejectionReason"
              rows="2"
              class="edit-textarea"
              placeholder="Indiquez le motif du refus..."
            ></textarea>
          </div>
        </div>

        <!-- Actions pour les demandes en attente -->
        <div
          class="action-section"
          *ngIf="selectedLeaveRequest.status === 'pending' && !isEditingLeave"
        >
          <h4>Actions</h4>
          <div class="action-buttons">
            <button class="btn btn-approve" (click)="approveLeaveRequest()">
              ‚úì Valider la demande
            </button>
            <button class="btn btn-reject" (click)="rejectLeaveRequest()">
              ‚úó Refuser la demande
            </button>
          </div>

          <div class="rejection-reason">
            <label for="rejectionReason">Motif de refus (optionnel) :</label>
            <textarea
              id="rejectionReason"
              [(ngModel)]="rejectionReason"
              placeholder="Indiquez le motif du refus..."
              rows="3"
            >
            </textarea>
          </div>
        </div>

        <!-- Actions pour toutes les demandes -->
        <div class="action-section" *ngIf="!isEditingLeave">
          <div class="secondary-actions">
            <button class="btn btn-edit" (click)="startEditingLeave()">
              ‚úèÔ∏è Modifier
            </button>
            <button class="btn btn-delete" (click)="deleteLeaveRequest()">
              üóëÔ∏è Supprimer
            </button>
          </div>
        </div>

        <!-- Actions en mode √©dition -->
        <div class="action-section" *ngIf="isEditingLeave">
          <div class="edit-actions">
            <button class="btn btn-save" (click)="saveLeaveChanges()">
              ‚úì Sauvegarder
            </button>
            <button class="btn btn-cancel" (click)="cancelEditingLeave()">
              ‚úï Annuler
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
